---
/**
 * TableOfContents Component
 * Displays article headings for navigation with scroll spy
 * Accessible with proper ARIA attributes
 */
import { useTranslations, defaultLang, type Lang } from "@/i18n";

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
  lang?: Lang;
}

const { headings, lang = defaultLang } = Astro.props;
const t = useTranslations(lang);

// Filter only h2 headings (main sections only for cleaner TOC)
const filteredHeadings = headings
  .filter((h) => h.depth === 2)
  .map((h) => ({
    ...h,
    // Truncate long headings and remove extra whitespace
    text: h.text.trim().slice(0, 60) + (h.text.length > 60 ? '...' : '')
  }))
  // Filter out headings that look like paragraphs (too long or contain certain patterns)
  .filter((h) => {
    const text = h.text.toLowerCase();
    // Skip if it looks like a paragraph (starts with common words that aren't heading-like)
    if (text.length > 80) return false;
    return true;
  });
---

{
  filteredHeadings.length > 0 && (
    <nav class="text-sm" aria-labelledby="toc-heading" id="toc-nav">
      <h4 id="toc-heading" class="font-semibold mb-3 text-foreground">
        {t('toc.title')}
      </h4>
      <ul class="space-y-1" role="list">
        {filteredHeadings.map((heading) => (
          <li>
            <a
              href={`#${heading.slug}`}
              data-toc-link={heading.slug}
              class:list={[
                "toc-link block py-1.5 border-l-2 pl-3 -ml-px transition-all duration-200",
                "text-muted-foreground border-transparent",
                "hover:text-foreground hover:border-muted-foreground/50",
                "focus:outline-none focus:text-primary focus:border-primary"
              ]}
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<script>
  function initScrollSpy() {
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    if (tocLinks.length === 0) return;

    // Get all heading IDs from TOC links
    const headingIds = Array.from(tocLinks).map(link =>
      (link as HTMLElement).dataset.tocLink
    );

    // Find all corresponding headings in the document
    const headings = headingIds
      .map(id => document.getElementById(id!))
      .filter((el): el is HTMLElement => el !== null);

    if (headings.length === 0) return;

    let currentActiveId: string | null = null;

    function updateActiveLink(id: string | null) {
      if (currentActiveId === id) return;

      // Remove active state from all links
      tocLinks.forEach(link => {
        link.classList.remove('text-primary', 'border-primary', 'font-medium');
        link.classList.add('text-muted-foreground', 'border-transparent');
      });

      // Add active state to current link
      if (id) {
        const activeLink = document.querySelector(`[data-toc-link="${id}"]`);
        if (activeLink) {
          activeLink.classList.remove('text-muted-foreground', 'border-transparent');
          activeLink.classList.add('text-primary', 'border-primary', 'font-medium');
        }
      }

      currentActiveId = id;
    }

    // Use IntersectionObserver for better performance
    const observerOptions = {
      root: null,
      rootMargin: '-100px 0px -66% 0px', // Account for header and bottom threshold
      threshold: 0
    };

    let visibleHeadings: Set<string> = new Set();

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const id = entry.target.id;
        if (entry.isIntersecting) {
          visibleHeadings.add(id);
        } else {
          visibleHeadings.delete(id);
        }
      });

      // Find the topmost visible heading
      if (visibleHeadings.size > 0) {
        for (const heading of headings) {
          if (visibleHeadings.has(heading.id)) {
            updateActiveLink(heading.id);
            break;
          }
        }
      } else {
        // Fallback: find the closest heading above viewport
        const scrollY = window.scrollY;
        let closestHeading: HTMLElement | null = null;

        for (const heading of headings) {
          const rect = heading.getBoundingClientRect();
          if (rect.top <= 100) {
            closestHeading = heading;
          }
        }

        if (closestHeading) {
          updateActiveLink(closestHeading.id);
        }
      }
    }, observerOptions);

    // Observe all headings
    headings.forEach(heading => observer.observe(heading));

    // Initial check for headings already in view
    requestAnimationFrame(() => {
      const scrollY = window.scrollY;
      if (scrollY > 100 && headings.length > 0) {
        // Find the closest heading above current scroll position
        for (const heading of headings) {
          const rect = heading.getBoundingClientRect();
          if (rect.top <= 100) {
            updateActiveLink(heading.id);
          }
        }
      }
    });

    // Cleanup on page navigation (for Astro view transitions)
    document.addEventListener('astro:before-swap', () => {
      observer.disconnect();
    }, { once: true });
  }

  // Initialize on page load
  initScrollSpy();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', initScrollSpy);
</script>
