---
import { Icon } from "astro-icon/components";
import { formatDate, getCategoryInfo, getCategoryGradient } from "@/lib/utils";
import { useTranslations, defaultLang, normalizeSlug, slugToPostId, type Lang } from "@/i18n";
import SocialActions from "@/components/ui/SocialActions.astro";

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  slug: string;
  readingTime?: number;
  image?: string;
  categories?: string[];
  variant?: "default" | "featured" | "horizontal" | "list";
  lang: Lang;
  showSocialActions?: boolean;
}

const {
  title,
  description,
  pubDate,
  slug,
  readingTime,
  image,
  categories = [],
  variant = "default",
  lang,
  showSocialActions = true,
} = Astro.props;

const t = useTranslations(lang);
const isDefault = lang === defaultLang;
// Use first category for primary styling, fallback to general
const primaryCategory = categories[0];
const { color, icon, label } = getCategoryInfo(primaryCategory);
const postUrl = isDefault ? `/blog/${slug}` : `/${lang}/blog/${slug}`;
const formattedDate = formatDate(pubDate, lang);
const dateIso = pubDate.toISOString();
const showCategoryBadge = categories.length > 0;
const cleanSlug = normalizeSlug(slug);
const postId = slugToPostId(slug);
---

{/* Featured Card - Vertical with colored background */}
{variant === "featured" && (
  <article class="group h-full">
    <a href={postUrl} class="block h-full">
      <div
        class="relative aspect-[3/4] rounded-xl overflow-hidden mb-3"
        style={`background: ${getCategoryGradient(color)}`}
      >
        {image ? (
          <img
            src={image}
            alt={title}
            class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-105"
            loading="lazy"
          />
        ) : (
          <div class="absolute inset-0 flex flex-col p-4">
            <span class="text-sm font-medium" style={`color: ${color}`}>{label}</span>
            <div class="flex-1 flex items-center justify-center">
              <Icon name={icon} class="w-16 h-16 opacity-40" style={`color: ${color}`} />
            </div>
          </div>
        )}
      </div>
      <h3 class="font-semibold text-foreground group-hover:text-primary transition-colors mb-2 line-clamp-2">
        {title}
      </h3>
      <div class="flex items-center gap-2 text-sm text-muted-foreground">
        <time datetime={dateIso}>{formattedDate}</time>
        {readingTime && <><span>路</span><span>{readingTime} min</span></>}
      </div>
    </a>
  </article>
)}

{/* Horizontal Card - Large featured article */}
{variant === "horizontal" && (
  <article class="group">
    <a href={postUrl} class="block">
      <div class="flex flex-col lg:flex-row gap-6">
        <div
          class="lg:w-72 aspect-video lg:aspect-[4/3] rounded-xl overflow-hidden flex-shrink-0"
          style={`background: ${getCategoryGradient(color)}`}
        >
          {image ? (
            <img
              src={image}
              alt={title}
              class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
              loading="lazy"
            />
          ) : (
            <div class="w-full h-full flex flex-col p-4">
              <span class="text-sm font-medium" style={`color: ${color}`}>{label}</span>
              <div class="flex-1 flex items-center justify-center">
                <Icon name={icon} class="w-12 h-12 opacity-40" style={`color: ${color}`} />
              </div>
            </div>
          )}
        </div>
        <div class="flex-1 py-2">
          {showCategoryBadge && (
            <span
              class="inline-block px-2 py-0.5 rounded text-xs font-medium mb-3"
              style={`background: ${color}20; color: ${color}`}
            >
              {label}
            </span>
          )}
          <h2 class="text-xl lg:text-2xl font-bold text-foreground group-hover:text-primary transition-colors mb-3 line-clamp-2">
            {title}
          </h2>
          <p class="text-muted-foreground mb-4 line-clamp-3">{description}</p>
          <div class="flex items-center gap-3 text-sm text-muted-foreground">
            <time datetime={dateIso}>{formattedDate}</time>
            {readingTime && (
              <>
                <span>路</span>
                <span class="flex items-center gap-1">
                  <Icon name="mdi:clock-outline" class="w-4 h-4" />
                  {readingTime} {t('blog.readingTime')}
                </span>
              </>
            )}
          </div>
        </div>
      </div>
    </a>
  </article>
)}

{/* List Card - Simple list item */}
{variant === "list" && (
  <article class="group py-4 border-b border-border last:border-0">
    <a href={postUrl} class="flex gap-4">
      <div class="flex-1 min-w-0">
        <h3 class="font-medium text-foreground group-hover:text-primary transition-colors line-clamp-2 mb-1">
          {title}
        </h3>
        <p class="text-sm text-muted-foreground line-clamp-1 mb-2">{description}</p>
        <div class="flex items-center gap-2 text-xs text-muted-foreground">
          <time datetime={dateIso}>{formattedDate}</time>
          {readingTime && <><span>路</span><span>{readingTime} min</span></>}
        </div>
      </div>
      {image && (
        <div class="hidden sm:block w-20 h-16 rounded-lg overflow-hidden flex-shrink-0 bg-muted">
          <img src={image} alt="" class="w-full h-full object-cover" loading="lazy" />
        </div>
      )}
    </a>
  </article>
)}

{/* Default Card - Grid card */}
{variant === "default" && (
  <article class="group h-full">
    <a href={postUrl} class="flex flex-col h-full rounded-xl overflow-hidden bg-card border border-border hover:border-primary/30 transition-all hover:shadow-lg">
      <div
        class="aspect-video overflow-hidden flex-shrink-0"
        style={`background: ${getCategoryGradient(color, 15)}`}
      >
        {image ? (
          <img
            src={image}
            alt={title}
            class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
            loading="lazy"
          />
        ) : (
          <div class="h-full w-full flex items-center justify-center">
            <Icon name={icon} class="w-12 h-12 opacity-30" style={`color: ${color}`} />
          </div>
        )}
      </div>
      <div class="p-4 flex flex-col flex-1">
        {showCategoryBadge && (
          <span
            class="inline-block px-2 py-0.5 rounded text-xs font-medium mb-2 w-fit"
            style={`background: ${color}15; color: ${color}`}
          >
            {label}
          </span>
        )}
        <h3 class="font-semibold text-foreground group-hover:text-primary transition-colors line-clamp-2 mb-2">
          {title}
        </h3>
        <p class="text-sm text-muted-foreground line-clamp-2 mb-3 flex-1">{description}</p>
        <div class="flex items-center gap-2 text-xs text-muted-foreground mt-auto">
          <time datetime={dateIso}>{formattedDate}</time>
          {readingTime && <><span>路</span><span>{readingTime} min</span></>}
        </div>
      </div>
    </a>
    {showSocialActions && (
      <div class="px-4 pb-4 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity duration-200">
        <SocialActions
          postId={postId}
          postTitle={title}
          postSlug={cleanSlug}
          lang={lang}
          showComments={true}
          size="sm"
        />
      </div>
    )}
  </article>
)}
