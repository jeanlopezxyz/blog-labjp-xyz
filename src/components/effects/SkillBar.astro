---
/**
 * SkillBar Component
 * Animated skill progress bar with GSAP
 */
interface Props {
  skill: string;
  level: number; // 0-100
  color?: string;
  class?: string;
}

const { skill, level, color = 'primary', class: className = '' } = Astro.props;
---

<div class:list={["skill-bar", className]} data-level={level}>
  <div class="flex justify-between mb-1">
    <span class="text-sm font-medium text-foreground">{skill}</span>
    <span class="skill-percent text-sm text-muted-foreground">0%</span>
  </div>
  <div class="h-2 rounded-full bg-muted overflow-hidden">
    <div
      class:list={[
        "skill-progress h-full rounded-full",
        color === 'primary' ? 'bg-primary' : `bg-${color}`
      ]}
      style="width: 0%; background-color: var(--skill-color, hsl(var(--primary)));"
    ></div>
  </div>
</div>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  function initSkillBars() {
    const bars = document.querySelectorAll('.skill-bar:not(.initialized)');

    bars.forEach(bar => {
      bar.classList.add('initialized');

      const level = parseInt(bar.getAttribute('data-level') || '0');
      const progressEl = bar.querySelector('.skill-progress') as HTMLElement;
      const percentEl = bar.querySelector('.skill-percent') as HTMLElement;

      if (!progressEl || !percentEl) return;

      const obj = { val: 0 };

      gsap.to(obj, {
        val: level,
        duration: 1.5,
        ease: 'power2.out',
        scrollTrigger: {
          trigger: bar,
          start: 'top 90%',
          toggleActions: 'play none none none'
        },
        onUpdate: () => {
          const current = Math.floor(obj.val);
          progressEl.style.width = `${current}%`;
          percentEl.textContent = `${current}%`;
        },
        onComplete: () => {
          progressEl.style.width = `${level}%`;
          percentEl.textContent = `${level}%`;
        }
      });
    });
  }

  initSkillBars();
  document.addEventListener('astro:after-swap', () => {
    ScrollTrigger.refresh();
    initSkillBars();
  });
</script>
