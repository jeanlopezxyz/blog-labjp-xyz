---
/**
 * Card3D Component
 * 3D tilt effect on hover using vanilla JS (no GSAP dependency for hover)
 */
interface Props {
  class?: string;
  intensity?: number;
  glare?: boolean;
}

const { class: className = '', intensity = 10, glare = true } = Astro.props;
---

<div
  class:list={["card-3d relative", className]}
  data-intensity={intensity}
  data-glare={glare}
>
  <div class="card-3d-inner">
    <slot />
  </div>
  {glare && <div class="card-3d-glare absolute inset-0 pointer-events-none opacity-0 rounded-inherit"></div>}
</div>

<style>
  .card-3d {
    perspective: 1000px;
  }

  .card-3d-inner {
    transition: transform 0.1s ease-out;
    transform-style: preserve-3d;
  }

  .card-3d-glare {
    background: linear-gradient(
      135deg,
      rgba(255, 255, 255, 0.25) 0%,
      rgba(255, 255, 255, 0) 60%
    );
    transition: opacity 0.3s ease;
    border-radius: inherit;
  }

  .card-3d:hover .card-3d-glare {
    opacity: 1;
  }
</style>

<script>
  function initCard3D() {
    const cards = document.querySelectorAll('.card-3d:not(.initialized)');

    cards.forEach(card => {
      card.classList.add('initialized');

      const inner = card.querySelector('.card-3d-inner') as HTMLElement;
      const glare = card.querySelector('.card-3d-glare') as HTMLElement;
      const intensity = parseFloat(card.getAttribute('data-intensity') || '10');
      const hasGlare = card.getAttribute('data-glare') === 'true';

      if (!inner) return;

      const handleMouseMove = (e: MouseEvent) => {
        const rect = (card as HTMLElement).getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;

        const rotateX = ((y - centerY) / centerY) * -intensity;
        const rotateY = ((x - centerX) / centerX) * intensity;

        inner.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;

        if (hasGlare && glare) {
          const glareX = (x / rect.width) * 100;
          const glareY = (y / rect.height) * 100;
          glare.style.background = `radial-gradient(circle at ${glareX}% ${glareY}%, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 60%)`;
        }
      };

      const handleMouseLeave = () => {
        inner.style.transform = 'rotateX(0) rotateY(0) scale3d(1, 1, 1)';
        if (glare) {
          glare.style.opacity = '0';
        }
      };

      const handleMouseEnter = () => {
        if (glare) {
          glare.style.opacity = '1';
        }
      };

      card.addEventListener('mousemove', handleMouseMove as EventListener);
      card.addEventListener('mouseleave', handleMouseLeave);
      card.addEventListener('mouseenter', handleMouseEnter);
    });
  }

  initCard3D();
  document.addEventListener('astro:after-swap', initCard3D);
</script>
