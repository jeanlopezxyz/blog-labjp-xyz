---
/**
 * TypingEffect Component
 * GSAP-powered typing animation for text
 */
interface Props {
  text: string;
  class?: string;
  speed?: number;
  delay?: number;
  cursor?: boolean;
}

const { text, class: className = '', speed = 0.05, delay = 0.5, cursor = true } = Astro.props;
---

<span
  class:list={["typing-effect inline-block", className]}
  data-text={text}
  data-speed={speed}
  data-delay={delay}
>
  <span class="typing-text"></span>
  {cursor && <span class="typing-cursor">|</span>}
</span>

<style>
  .typing-cursor {
    animation: blink 1s infinite;
    color: currentColor;
  }

  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  .typing-effect.done .typing-cursor {
    animation: none;
    opacity: 0;
  }
</style>

<script>
  import { gsap } from 'gsap';

  function initTypingEffects() {
    const elements = document.querySelectorAll('.typing-effect:not(.initialized)');

    elements.forEach(el => {
      el.classList.add('initialized');

      const text = el.getAttribute('data-text') || '';
      const speed = parseFloat(el.getAttribute('data-speed') || '0.05');
      const delay = parseFloat(el.getAttribute('data-delay') || '0.5');
      const textEl = el.querySelector('.typing-text') as HTMLElement;

      if (!textEl) return;

      const chars = text.split('');
      let currentText = '';

      gsap.to({}, {
        duration: chars.length * speed,
        delay: delay,
        ease: 'none',
        onUpdate: function() {
          const progress = this.progress();
          const charIndex = Math.floor(progress * chars.length);
          const newText = chars.slice(0, charIndex + 1).join('');

          if (newText !== currentText) {
            currentText = newText;
            textEl.textContent = currentText;
          }
        },
        onComplete: () => {
          textEl.textContent = text;
          el.classList.add('done');
        }
      });
    });
  }

  initTypingEffects();
  document.addEventListener('astro:after-swap', initTypingEffects);
</script>
