---
/**
 * ReadingProgress Component
 * Shows a progress bar indicating how far the user has scrolled through the article
 * Uses GSAP ScrollTrigger for smooth animation
 */
---

<div id="reading-progress" class="fixed top-0 left-0 w-full h-1 z-50 pointer-events-none">
  <div
    id="progress-bar"
    class="h-full bg-gradient-to-r from-primary via-primary to-primary/80 origin-left"
    style="transform: scaleX(0);"
  ></div>
</div>

<script>
  import { gsap } from 'gsap';
  import { ScrollTrigger } from 'gsap/ScrollTrigger';

  gsap.registerPlugin(ScrollTrigger);

  function initReadingProgress() {
    const progressBar = document.getElementById('progress-bar');
    const article = document.querySelector('article');

    if (!progressBar || !article) return;

    // Kill any existing ScrollTrigger for this element
    ScrollTrigger.getAll().forEach(st => {
      if (st.vars.trigger === article) st.kill();
    });

    gsap.to(progressBar, {
      scaleX: 1,
      ease: 'none',
      scrollTrigger: {
        trigger: article,
        start: 'top top',
        end: 'bottom bottom',
        scrub: 0.3
      }
    });
  }

  // Initialize on page load
  initReadingProgress();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', () => {
    ScrollTrigger.refresh();
    initReadingProgress();
  });

  // Cleanup before page swap
  document.addEventListener('astro:before-swap', () => {
    ScrollTrigger.getAll().forEach(st => st.kill());
  });
</script>
