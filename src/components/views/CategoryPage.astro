---
/**
 * CategoryPage Component
 * Shared category listing page for both languages
 */
import BaseLayout from "@/layouts/BaseLayout.astro";
import PostCardHorizontal from "@/components/blog/PostCardHorizontal.astro";
import Sidebar from "@/components/layout/Sidebar.astro";
import SocialActions from "@/components/ui/SocialActions.astro";
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";
import { calculateReadingTime, getCategoryInfo, getRelativeTime } from "@/lib/utils";
import { useTranslations, normalizeSlug, slugToPostId, isPostForLang, type Lang } from "@/i18n";

interface Props {
  lang: Lang;
  category: string;
}

const { lang, category } = Astro.props;
const t = useTranslations(lang);
const basePath = `/${lang}/blog`;
const homePath = `/${lang}`;

const { color, icon, label } = getCategoryInfo(category);

const posts = (await getCollection("blog", ({ id, data }) => {
  if (data.draft) return false;
  // Check if the post has this category in its categories array
  if (!data.categories?.includes(category)) return false;
  return isPostForLang(id, lang);
})).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const featuredPost = posts[0];
const otherPosts = posts.slice(1);

function getPostUrl(slug: string) {
  return `${basePath}/${normalizeSlug(slug)}`;
}
---

<BaseLayout
  title={label}
  description={`${t('cat.articlesAbout')} ${label}`}
  currentCategory={category}
  lang={lang}
>
  <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
    <div class="lg:grid lg:grid-cols-[1fr_280px] lg:gap-16">
      <div>
        <header class="mb-8">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center" style={`background: ${color}15`}>
              <Icon name={icon} class="w-6 h-6" style={`color: ${color}`} />
            </div>
            <div>
              <h1 class="text-2xl font-bold text-foreground">{label}</h1>
              <p class="text-sm text-muted-foreground">
                {posts.length} {posts.length === 1 ? t('blog.article') : t('blog.articles')}
              </p>
            </div>
          </div>
        </header>

        {posts.length > 0 ? (
          <>
            {featuredPost && (
              <section class="mb-8">
                <article class="group">
                  <a href={getPostUrl(featuredPost.slug)} class="block">
                    {featuredPost.data.image && (
                      <div class="aspect-[2/1] rounded-xl overflow-hidden mb-5 bg-muted">
                        <img
                          src={featuredPost.data.image}
                          alt={featuredPost.data.title}
                          class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                        />
                      </div>
                    )}
                    <h2 class="text-xl md:text-2xl font-bold text-foreground group-hover:text-primary transition-colors mb-3">
                      {featuredPost.data.title}
                    </h2>
                    <p class="text-muted-foreground text-sm leading-relaxed mb-4 line-clamp-2">
                      {featuredPost.data.description}
                    </p>
                    <div class="flex items-center gap-2 text-xs text-muted-foreground/70">
                      <time datetime={featuredPost.data.pubDate.toISOString()}>
                        {getRelativeTime(featuredPost.data.pubDate, lang)}
                      </time>
                      <span class="text-muted-foreground/40">Â·</span>
                      <span>{calculateReadingTime(featuredPost.body ?? "")} {t('blog.min')}</span>
                    </div>
                  </a>
                  <!-- Social actions on hover -->
                  <div class="mt-3 opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity duration-200">
                    <SocialActions
                      postId={slugToPostId(featuredPost.slug)}
                      postTitle={featuredPost.data.title}
                      postSlug={normalizeSlug(featuredPost.slug)}
                      lang={lang}
                      showComments={true}
                      size="sm"
                      variant="centered"
                    />
                  </div>
                </article>
              </section>
            )}

            {/* All posts from this category displayed as cards */}
            {otherPosts.length > 0 && (
              <section class="pt-8 border-t border-border/30">
                <div class="flex flex-col gap-4">
                  {otherPosts.map((post) => (
                    <PostCardHorizontal
                      title={post.data.title}
                      description={post.data.description}
                      pubDate={post.data.pubDate}
                      slug={post.slug}
                      image={post.data.image}
                      readingTime={calculateReadingTime(post.body ?? "")}
                      lang={lang}
                    />
                  ))}
                </div>
              </section>
            )}
          </>
        ) : (
          <div class="text-center py-16">
            <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style={`background: ${color}15`}>
              <Icon name={icon} class="w-8 h-8" style={`color: ${color}`} />
            </div>
            <h2 class="text-lg font-semibold text-foreground mb-2">{t('cat.noArticles')}</h2>
            <p class="text-muted-foreground mb-6">
              {t('cat.noArticlesYet')} {label.toLowerCase()}.
            </p>
            <a href={homePath} class="text-sm font-medium text-primary hover:underline">
              {t('cat.backHome')}
            </a>
          </div>
        )}
      </div>

      <div class="hidden lg:block">
        <div class="sticky top-24">
          <Sidebar lang={lang} currentCategory={category} />
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
