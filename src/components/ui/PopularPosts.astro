---
/**
 * PopularPosts Component
 * Dynamically fetches and displays the most viewed posts from the API
 */
import { Icon } from "astro-icon/components";
import { getCollection } from "astro:content";
import { useTranslations, defaultLang, isPostForLang, normalizeSlug, type Lang } from "@/i18n";

interface Props {
  lang?: Lang;
  limit?: number;
}

const { lang = defaultLang, limit = 5 } = Astro.props;
const t = useTranslations(lang);

const allPosts = await getCollection("blog", ({ id, data }) => {
  if (data.draft) return false;
  return isPostForLang(id, lang);
});

const postsData = JSON.stringify(
  allPosts.map(post => ({
    slug: normalizeSlug(post.slug),
    title: post.data.title,
    image: post.data.image,
    pubDate: post.data.pubDate.toISOString()
  }))
);
---

<div id="popular-posts-container" class="bg-card/50 rounded-2xl p-5" data-limit={limit} data-posts={postsData}>
  <div class="flex items-center gap-2 mb-4">
    <Icon name="mdi:fire" class="w-4 h-4 text-orange-500" />
    <h3 class="text-xs font-semibold text-muted-foreground uppercase tracking-wide">
      {t('stats.mostViewed')}
    </h3>
  </div>

  <div id="popular-posts-loading" class="space-y-4">
    {[1, 2, 3].map(() => (
      <div class="animate-pulse">
        <div class="aspect-[16/9] rounded-lg bg-muted mb-2"></div>
        <div class="h-4 bg-muted rounded w-3/4 mb-1"></div>
        <div class="h-3 bg-muted rounded w-1/4"></div>
      </div>
    ))}
  </div>

  <div id="popular-posts-list" class="space-y-4 hidden"></div>

  <div id="popular-posts-error" class="hidden text-sm text-muted-foreground text-center py-4">
    {t('stats.errorLoading')}
  </div>
</div>

<script>
  import { API_ENDPOINTS } from '@/lib/types';

  interface PostData {
    slug: string;
    title: string;
    image?: string;
    pubDate: string;
  }

  interface ViewData {
    slug: string;
    views: number;
  }

  function initPopularPosts() {
    const container = document.getElementById('popular-posts-container');
    if (!container) return;

    const limit = parseInt(container.dataset.limit || '5');
    const postsData: PostData[] = JSON.parse(container.dataset.posts || '[]');
    const loadingEl = document.getElementById('popular-posts-loading');
    const listEl = document.getElementById('popular-posts-list');
    const errorEl = document.getElementById('popular-posts-error');

    if (!loadingEl || !listEl || !errorEl) return;

    const { t, locale } = window.__i18n || { t: {}, locale: 'es-ES' };
    const baseUrl = locale.startsWith('en') ? '/en/blog/' : '/blog/';

    fetch(API_ENDPOINTS.VIEWS)
      .then(res => res.json())
      .then((views: ViewData[]) => {
        const popularPosts = views
          .slice(0, limit)
          .map(view => {
            const post = postsData.find(p => p.slug === view.slug);
            return post ? { ...post, views: view.views } : null;
          })
          .filter(Boolean)
          .slice(0, limit);

        if (popularPosts.length === 0) {
          const fallback = postsData
            .sort((a, b) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime())
            .slice(0, limit);
          renderPosts(fallback, false);
        } else {
          renderPosts(popularPosts, true);
        }

        loadingEl.classList.add('hidden');
        listEl.classList.remove('hidden');
      })
      .catch(() => {
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
      });

    function renderPosts(posts: Array<PostData & { views?: number }>, showViews: boolean) {
      listEl.innerHTML = posts.map(post => `
        <a href="${baseUrl}${post.slug}" class="group block">
          ${post.image ? `
            <div class="aspect-[16/9] rounded-lg overflow-hidden mb-2 bg-muted">
              <img src="${post.image}" alt="" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy" />
            </div>
          ` : ''}
          <h4 class="text-sm font-medium text-foreground group-hover:text-primary transition-colors line-clamp-2 leading-snug mb-1">
            ${post.title}
          </h4>
          ${showViews && post.views ? `
            <div class="flex items-center gap-1 text-xs text-muted-foreground/70">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              ${post.views} ${t['stats.views']}
            </div>
          ` : ''}
        </a>
      `).join('');
    }
  }

  initPopularPosts();
  document.addEventListener('astro:after-swap', initPopularPosts);
</script>
