---
import { Icon } from "astro-icon/components";
import { NAV_ITEMS, CATEGORIES, RSS_URL } from "@/lib/constants";
import { getLangFromUrl, useTranslations, getLocalizedPath, languages, defaultLang } from "@/i18n";

// Language display names (short codes)
const LANG_CODES = {
  es: "ES",
  en: "EN",
} as const;

// Función para obtener URL del idioma alternativo (mantiene la página actual)
function getLangSwitchUrl(targetLang: string, currentLang: string, pathname: string): string {
  // Normalizar pathname (quitar trailing slash excepto para root)
  const normalizedPath = pathname === '/' ? '/' : pathname.replace(/\/$/, '');

  // Si estamos en la raíz, ir a /{targetLang}/
  if (normalizedPath === '/') {
    return `/${targetLang}/`;
  }

  // Reemplazar el prefijo de idioma actual con el nuevo
  const pathWithoutLang = normalizedPath.replace(new RegExp(`^/(${Object.keys(languages).join('|')})`), '');
  return `/${targetLang}${pathWithoutLang || ''}`;
}

interface Props {
  currentCategory?: string;
}

const { currentCategory } = Astro.props;
const pathname = Astro.url.pathname;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const isNavActive = (href: string) => {
  const localizedHref = getLocalizedPath(href, lang);

  // For home page, only exact match (with or without trailing slash)
  if (href === '/') {
    const normalizedPathname = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname;
    const normalizedHref = localizedHref.endsWith('/') ? localizedHref.slice(0, -1) : localizedHref;
    return normalizedPathname === normalizedHref || normalizedPathname === '';
  }

  // For other pages, check exact match or if it starts with the href
  return pathname === localizedHref || pathname.startsWith(localizedHref + '/');
};

const getNavLabel = (key: string) => t(key as keyof ReturnType<typeof useTranslations>);
---

<header class="sticky top-0 z-50 bg-card/95 backdrop-blur-md" role="banner">
  <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-14 lg:h-16">

      <!-- Logo -->
      <a href={getLocalizedPath('/', lang)} class="flex items-center gap-3 shrink-0" aria-label={`labjp.xyz - ${t('a11y.goToHome')}`}>
        <span class="font-mono font-bold text-2xl text-primary">&gt;_</span>
        <span class="font-semibold text-xl text-foreground hidden sm:inline">labjp.xyz</span>
      </a>

      <!-- Center: Navigation (hidden on mobile/tablet, only show on xl screens) -->
      <nav class="hidden xl:flex items-center" aria-label={t('nav.mainNav')}>
        <!-- Primary Nav: Home -->
        <ul class="flex items-center" role="list">
          {NAV_ITEMS.filter(item => ['/'].includes(item.href)).map((item) => (
            <li>
              <a
                href={getLocalizedPath(item.href, lang)}
                class:list={[
                  "px-2.5 py-1.5 text-sm whitespace-nowrap transition-colors rounded-md",
                  isNavActive(item.href)
                    ? "font-medium text-primary bg-primary/10"
                    : "text-muted-foreground hover:text-foreground hover:bg-muted/50",
                ]}
              >
                {getNavLabel(item.key)}
              </a>
            </li>
          ))}
        </ul>

        <!-- All Categories -->
        <ul class="flex items-center" role="list">
          {CATEGORIES.map((cat) => {
            const isActive = currentCategory === cat.id;
            return (
              <li>
                <a
                  href={getLocalizedPath(`/category/${cat.id}`, lang)}
                  class:list={[
                    "px-2.5 py-1.5 text-sm whitespace-nowrap transition-colors rounded-md",
                    isActive
                      ? "font-medium text-primary bg-primary/10"
                      : "text-muted-foreground hover:text-foreground hover:bg-muted/50",
                  ]}
                >
                  {cat.label}
                </a>
              </li>
            );
          })}
        </ul>

        <!-- Secondary Nav: Archive, About -->
        <ul class="flex items-center" role="list">
          {NAV_ITEMS.filter(item => ['/blog', '/about'].includes(item.href)).map((item) => (
            <li>
              <a
                href={getLocalizedPath(item.href, lang)}
                class:list={[
                  "px-2.5 py-1.5 text-sm whitespace-nowrap transition-colors rounded-md",
                  isNavActive(item.href)
                    ? "font-medium text-primary bg-primary/10"
                    : "text-muted-foreground hover:text-foreground hover:bg-muted/50",
                ]}
              >
                {getNavLabel(item.key)}
              </a>
            </li>
          ))}
        </ul>
      </nav>

      <!-- Right: Actions -->
      <div class="flex items-center gap-0.5 sm:gap-1">
        <button
          id="search-button"
          class="p-2 text-muted-foreground hover:text-foreground hover:bg-muted rounded-lg transition-colors"
          aria-label={t('nav.search')}
        >
          <Icon name="mdi:magnify" class="w-5 h-5" aria-hidden="true" />
        </button>

        <!-- Language Switcher Dropdown -->
        <div class="relative" id="lang-dropdown-container">
          <button
            id="lang-toggle"
            class="flex items-center gap-1 px-2 py-1.5 text-sm font-medium text-muted-foreground hover:text-foreground hover:bg-muted rounded-lg transition-colors"
            aria-label={t('nav.langToggle')}
            aria-expanded="false"
            aria-haspopup="menu"
            aria-controls="lang-dropdown"
          >
            <span>{LANG_CODES[lang as keyof typeof LANG_CODES]}</span>
            <Icon name="mdi:chevron-down" class="w-4 h-4" aria-hidden="true" />
          </button>
          <div
            id="lang-dropdown"
            class="hidden absolute right-0 mt-2 w-32 bg-card border border-border rounded-lg shadow-lg py-1 z-50"
            role="menu"
            aria-labelledby="lang-toggle"
          >
            {Object.entries(languages).map(([langCode, langName]) => (
              <a
                href={getLangSwitchUrl(langCode, lang, pathname)}
                class:list={[
                  "flex items-center justify-between px-4 py-2 text-sm transition-colors",
                  lang === langCode ? "text-primary font-medium bg-muted/50" : "text-muted-foreground hover:text-foreground hover:bg-muted",
                ]}
                role="menuitem"
              >
                <span>{langName}</span>
                <span class="text-xs opacity-60">{LANG_CODES[langCode as keyof typeof LANG_CODES]}</span>
              </a>
            ))}
          </div>
        </div>

        <a
          href="#subscribe"
          class="hidden md:inline-flex items-center gap-2 ml-1 px-3 py-1.5 text-sm font-medium bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
        >
          <Icon name="mdi:email-outline" class="w-4 h-4" aria-hidden="true" />
          <span class="hidden xl:inline">{t('nav.subscribe')}</span>
        </a>

      </div>
    </div>
  </div>

  <!-- Mobile/Tablet Category Bar -->
  <div class="xl:hidden bg-card/80">
    <div class="max-w-screen-2xl mx-auto">
      <nav class="overflow-x-auto scrollbar-hide" aria-label={t('nav.navigation')}>
        <ul class="flex items-center justify-center gap-1.5 px-4 py-2" role="list">
          <li>
            <a
              href={getLocalizedPath('/', lang)}
              class:list={[
                "inline-flex items-center px-3 py-1.5 text-xs sm:text-sm font-medium rounded-full transition-colors whitespace-nowrap",
                isNavActive('/')
                  ? "bg-primary text-primary-foreground"
                  : "bg-muted/60 text-muted-foreground hover:bg-muted hover:text-foreground",
              ]}
            >
              {t('nav.home')}
            </a>
          </li>
          {CATEGORIES.map((cat) => {
            const isActive = currentCategory === cat.id;
            return (
              <li>
                <a
                  href={getLocalizedPath(`/category/${cat.id}`, lang)}
                  class:list={[
                    "inline-flex items-center px-3 py-1.5 text-xs sm:text-sm font-medium rounded-full transition-colors whitespace-nowrap",
                    isActive
                      ? "bg-primary text-primary-foreground"
                      : "bg-muted/60 text-muted-foreground hover:bg-muted hover:text-foreground",
                  ]}
                >
                  {cat.label}
                </a>
              </li>
            );
          })}
          <li>
            <a
              href={getLocalizedPath('/blog', lang)}
              class:list={[
                "inline-flex items-center px-3 py-1.5 text-xs sm:text-sm font-medium rounded-full transition-colors whitespace-nowrap",
                isNavActive('/blog')
                  ? "bg-primary text-primary-foreground"
                  : "bg-muted/60 text-muted-foreground hover:bg-muted hover:text-foreground",
              ]}
            >
              {t('nav.archive')}
            </a>
          </li>
          <li>
            <a
              href={getLocalizedPath('/about', lang)}
              class:list={[
                "inline-flex items-center px-3 py-1.5 text-xs sm:text-sm font-medium rounded-full transition-colors whitespace-nowrap",
                isNavActive('/about')
                  ? "bg-primary text-primary-foreground"
                  : "bg-muted/60 text-muted-foreground hover:bg-muted hover:text-foreground",
              ]}
            >
              {t('nav.about')}
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>

</header>

<!-- Search Modal -->
<div id="search-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="search-title" aria-hidden="true">
  <div class="relative bg-card border border-border rounded-2xl p-6 max-w-xl w-full mx-4 shadow-2xl">
    <button id="close-search" class="absolute top-4 right-4 text-muted-foreground hover:text-foreground transition-colors focus:outline-none focus:ring-2 focus:ring-primary rounded" aria-label={t('search.close')}>
      <Icon name="mdi:close" class="w-5 h-5" aria-hidden="true" />
    </button>
    <h2 id="search-title" class="text-lg font-semibold text-foreground mb-4">{t('search.title')}</h2>
    <div class="relative">
      <Icon name="mdi:magnify" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" aria-hidden="true" />
      <input
        type="search"
        id="search-input"
        placeholder={t('search.placeholder')}
        class="w-full pl-10 pr-4 py-3 rounded-lg bg-muted border border-border text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
        autocomplete="off"
      />
    </div>
    <div id="search-results" class="mt-4 max-h-80 overflow-y-auto" role="listbox" aria-label={t('search.results')}>
      <p class="text-sm text-muted-foreground text-center py-8">{t('search.typing')}</p>
    </div>
  </div>
</div>

<!-- Subscribe Modal -->
<div id="subscribe-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="subscribe-title" aria-hidden="true">
  <div class="relative bg-card border border-border rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
    <button id="close-modal" class="absolute top-4 right-4 text-muted-foreground hover:text-foreground transition-colors focus:outline-none focus:ring-2 focus:ring-primary rounded" aria-label={t('subscribe.close')}>
      <Icon name="mdi:close" class="w-5 h-5" aria-hidden="true" />
    </button>
    <div class="text-center mb-6">
      <div class="w-12 h-12 rounded-full bg-primary/20 flex items-center justify-center mx-auto mb-4">
        <Icon name="mdi:email-outline" class="w-6 h-6 text-primary" aria-hidden="true" />
      </div>
      <h2 id="subscribe-title" class="text-xl font-bold text-foreground mb-2">{t('subscribe.title')}</h2>
      <p class="text-muted-foreground text-sm">{t('subscribe.description')}</p>
    </div>
    <form class="space-y-4">
      <label for="subscribe-email" class="sr-only">Email</label>
      <input
        type="email"
        id="subscribe-email"
        placeholder={t('sidebar.email')}
        class="w-full px-4 py-3 rounded-lg bg-muted border border-border text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
        required
      />
      <button
        type="submit"
        class="w-full py-3 bg-primary text-primary-foreground font-medium rounded-lg hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
      >
        {t('subscribe.button')}
      </button>
    </form>
    <p class="text-xs text-muted-foreground mt-4 text-center">
      {t('subscribe.orFollow')} <a href={RSS_URL} class="text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-primary rounded">RSS</a>
    </p>
  </div>
</div>

<script>
  import { STORAGE_KEYS } from '@/lib/types';

  function initHeader() {
    const subscribeLinks = document.querySelectorAll('a[href="#subscribe"]');
    const subscribeModal = document.getElementById("subscribe-modal");
    const closeSubscribe = document.getElementById("close-modal");
    const searchButton = document.getElementById("search-button");
    const searchModal = document.getElementById("search-modal");
    const closeSearch = document.getElementById("close-search");
    const searchInput = document.getElementById("search-input") as HTMLInputElement;
    const searchResults = document.getElementById("search-results");
    const langToggle = document.getElementById("lang-toggle");
    const langDropdown = document.getElementById("lang-dropdown");

    const toggleModal = (modal: HTMLElement | null, show: boolean): void => {
      if (!modal) return;
      modal.classList.toggle("hidden", !show);
      modal.classList.toggle("flex", show);
      modal.setAttribute("aria-hidden", String(!show));

      // Manage body scroll and focus trap
      if (show) {
        document.body.style.overflow = "hidden";
        const firstFocusable = modal.querySelector<HTMLElement>('input, button, a');
        firstFocusable?.focus();
      } else {
        document.body.style.overflow = "";
      }
    };

    // Language dropdown
    langToggle?.addEventListener("click", (e) => {
      e.stopPropagation();
      const isExpanded = langToggle.getAttribute("aria-expanded") === "true";
      langToggle.setAttribute("aria-expanded", String(!isExpanded));
      langDropdown?.classList.toggle("hidden");
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
      if (langDropdown && !langDropdown.classList.contains("hidden")) {
        const container = document.getElementById("lang-dropdown-container");
        if (container && !container.contains(e.target as Node)) {
          langDropdown.classList.add("hidden");
          langToggle?.setAttribute("aria-expanded", "false");
        }
      }
    });

    // Subscribe modal
    subscribeLinks.forEach(link => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        toggleModal(subscribeModal, true);
      });
    });

    closeSubscribe?.addEventListener("click", () => toggleModal(subscribeModal, false));
    subscribeModal?.addEventListener("click", (e) => {
      if (e.target === subscribeModal) toggleModal(subscribeModal, false);
    });

    // Search modal
    searchButton?.addEventListener("click", () => {
      toggleModal(searchModal, true);
      searchInput?.focus();
    });

    closeSearch?.addEventListener("click", () => toggleModal(searchModal, false));
    searchModal?.addEventListener("click", (e) => {
      if (e.target === searchModal) toggleModal(searchModal, false);
    });

    // Search functionality
    interface SearchPost {
      title: string;
      description: string;
      slug: string;
      categories?: string[];
    }

    let posts: SearchPost[] = [];
    let selectedIndex = -1;
    let debounceTimer: ReturnType<typeof setTimeout>;
    const { t } = window.__i18n || { t: {} };

    fetch('/search.json')
      .then(res => {
        if (!res.ok) throw new Error('Failed to fetch search data');
        return res.json() as Promise<SearchPost[]>;
      })
      .then((data) => { posts = data; })
      .catch(() => {
        // Silent fail - search will show no results
      });

    // Debounced search function
    function performSearch(query: string) {
      if (!query) {
        if (searchResults) {
          searchResults.innerHTML = `<p class="text-sm text-muted-foreground text-center py-8">${t['search.typing']}</p>`;
        }
        selectedIndex = -1;
        return;
      }

      const filtered = posts.filter(post =>
        post.title.toLowerCase().includes(query) ||
        post.description.toLowerCase().includes(query) ||
        post.categories?.some(cat => cat.toLowerCase().includes(query))
      );

      if (searchResults) {
        selectedIndex = -1;
        if (filtered.length === 0) {
          searchResults.innerHTML = `<p class="text-sm text-muted-foreground text-center py-8">${t['search.noResults']}</p>`;
        } else {
          searchResults.innerHTML = '';

          // Result count
          const countDiv = document.createElement('div');
          countDiv.className = 'text-xs text-muted-foreground px-3 py-2 border-b border-border';
          countDiv.textContent = `${filtered.length} ${filtered.length === 1 ? t['search.result'] : t['search.results']}`;
          searchResults.appendChild(countDiv);

          filtered.slice(0, 10).forEach((post, index) => {
            const link = document.createElement('a');
            // Handle slug format: "en/article-name" or "es/article-name"
            const slugParts = post.slug.split('/');
            const lang = slugParts[0];
            const articleSlug = slugParts.slice(1).join('/');
            // Build correct URL: /en/blog/article-name or /es/blog/article-name
            link.href = `/${lang}/blog/${articleSlug}`;
            link.className = 'search-result block p-3 rounded-lg hover:bg-muted focus:bg-muted focus:outline-none transition-colors';
            link.setAttribute('role', 'option');
            link.setAttribute('data-index', String(index));

            const title = document.createElement('h3');
            title.className = 'font-medium text-foreground';
            title.textContent = post.title;

            const desc = document.createElement('p');
            desc.className = 'text-sm text-muted-foreground line-clamp-1';
            desc.textContent = post.description;

            link.appendChild(title);
            link.appendChild(desc);
            searchResults.appendChild(link);
          });
        }
      }
    }

    // Update selected result styling
    function updateSelection() {
      const results = searchResults?.querySelectorAll('.search-result');
      results?.forEach((el, i) => {
        if (i === selectedIndex) {
          el.classList.add('bg-muted');
          el.scrollIntoView({ block: 'nearest' });
        } else {
          el.classList.remove('bg-muted');
        }
      });
    }

    searchInput?.addEventListener("input", (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase().trim();
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => performSearch(query), 150);
    });

    // Keyboard navigation for search results
    searchInput?.addEventListener("keydown", (e) => {
      const results = searchResults?.querySelectorAll('.search-result');
      if (!results || results.length === 0) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
        updateSelection();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, 0);
        updateSelection();
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        const selectedLink = results[selectedIndex] as HTMLAnchorElement;
        if (selectedLink) window.location.href = selectedLink.href;
      }
    });

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        toggleModal(searchModal, true);
        searchInput?.focus();
      }
      if (e.key === "Escape") {
        toggleModal(searchModal, false);
        toggleModal(subscribeModal, false);
        // Close language dropdown
        langDropdown?.classList.add("hidden");
        langToggle?.setAttribute("aria-expanded", "false");
      }
    });
  }

  initHeader();
  document.addEventListener("astro:after-swap", initHeader);
</script>
